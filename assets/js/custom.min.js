"use strict";var vError,form=document.querySelector(".form"),returnHTML=document.querySelector(".form-return-js"),createTooltip=function(e,t){return(vError=document.createElement("div")).classList.add("form__tooltip"),vError.textContent=e,t.appendChild(vError),!1},validation=function(){var e=document.querySelector(".form__input-label"),t=document.querySelector(".form__checkbox-label");if(""==input.value)return input.focus(),createTooltip("To pole jest wymagane.",e);return input.value.match(/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/)?0!=document.querySelector(".form__checkbox").checked||createTooltip("Wymagana zgoda",t):(input.focus(),createTooltip("Błędny adres e-mail.",e))},addToDataBase=function(){returnHTML.innerHTML="";var e=document.querySelector(".form__input"),t=document.querySelector(".form__loader");t.classList.add("active");var a=new FormData;a.append("email",e.value),a.append("id",select.dataset.id),fetch("inc/subscription.php",{method:"POST",body:a}).then(function(e){return e.text()}).then(function(e){returnHTML.innerHTML=e,form.reset(),placeholder.classList.remove("active"),t.classList.remove("active")}).catch(function(e){return console.log(e)})};form.addEventListener("submit",function(e){e.preventDefault(),validation()&&addToDataBase()}),document.addEventListener("click",function(){vError&&vError.remove()});var input=document.querySelector(".form__input"),placeholder=document.querySelector(".form__placeholder");input.addEventListener("focus",function(e){placeholder.classList.add("active")}),input.addEventListener("focusout",function(e){""==input.value&&placeholder.classList.remove("active")});var loadQuality=function(){document.querySelector(".loader")||(dataWrapper.innerHTML='\n        <div class="loader">\n            <img class="loader__cloud-1" src="assets/images/Loader1.svg">\n            <img class="loader__cloud-2" src="assets/images/Loader2.svg">\n        </div>');var a=stations.filter(function(e){return e.id==select.dataset.id}),e=new FormData;e.append("url","http://api.gios.gov.pl/pjp-api/rest/aqindex/getIndex/"+select.dataset.id),fetch("inc/ajax.php",{method:"POST",body:e}).then(function(e){return e.json()}).then(function(e){var t="";switch((quality=e).stIndexLevel.indexLevelName){case"Bardzo dobry":case"Dobry":t="font-good";break;case"Umiarkowany":case"Dostateczny":t="font-neutral";break;case"Zły":case"Bardzo zły":t="font-bad"}htmlText+='\n            <div class="data__wrapper">\n                <div class="box box--left box-shadow">\n                    <p class="station">'.concat(a[0].city.name,'</p>\n                    <p>\n                        <span>Indeks jakości powietrza:</span>\n                        <span class="quality ').concat(t,'">').concat(quality.stIndexLevel.indexLevelName,'</span>\n                    </p>\n                    <div class="image"></div>\n                    <p>\n                        <span>Data pomiaru:</span>\n                        <span class="date">').concat(quality.stCalcDate,"</span>\n                    </p>\n                </div>\n            "),loadSensors()}).catch(function(e){return console.log(e)})},sensorsData=[],decimal=function(e,t){var a=Math.pow(10,t+1);return(e=Math.round(Math.round(e*a)/10))/(a/10)},sensorTemplate=function(e,t){var a,s="µg/m3";switch(t.param.idParam){case 1:a=350;break;case 3:a=50;break;case 5:a=120;break;case 6:a=200;break;case 8:a=1e4,s="mg/m3";break;case 10:a=5;break;case 69:a=25}var n=Math.round(e/a*100),c="";c=n<40?"bg-good":n<100?"bg-neutral":"bg-bad";var o={percent:n,HTML:'\n        <div class="sensor">\n            <p>\n                <span class="sensor__label" data-id="'.concat(t.param.idParam,'">').concat(t.param.paramName,": </span>\n                <span>").concat(decimal(e,5)," ").concat(s,'</span>\n            </p>\n            <div class="sensor__row">\n                <div class="sensor__bar">\n                    <div class="sensor__indicator ').concat(c,'" style="width: ').concat(n,'%"></div>\n                </div>\n\n                <span class="sensor__percent ').concat(c,'" >').concat(n,"%</span>\n            </div>\n        </div>\n        ")};sensorsData.push(o)},loadSensorData=function(e,n){var t=new FormData;t.append("url","http://api.gios.gov.pl/pjp-api/rest/data/getData/"+e),fetch("inc/ajax.php",{method:"POST",body:t}).then(function(e){return e.json()}).then(function(e){for(var t=e,a=!1,s=0;s<t.values.length;s++)if(null!=t.values[s].value){a=t.values[s].value;break}a&&sensorTemplate(a,sensors[n]),++counter==sensors.length&&(sensorsData.sort(function(e,t){return t.percent-e.percent}),sensorsData.forEach(function(e){htmlText+=e.HTML}),sensorsData.splice(0,sensorsData.length),htmlText+="\n                    </div>\n                </div>\n                ",dataWrapper.innerHTML=htmlText,switchImage())}).catch(function(e){return console.log(e)})},loadSensors=function(){var e=new FormData;e.append("url","http://api.gios.gov.pl/pjp-api/rest/station/sensors/"+select.dataset.id),fetch("inc/ajax.php",{method:"POST",body:e}).then(function(e){return e.json()}).then(function(e){htmlText+='<div class="box box--right box-shadow">',(sensors=e).forEach(function(e,t){loadSensorData(e.id,t)})}).catch(function(e){return console.log(e)})},createSelect=function(e){e.sort(function(e,t){return e.city.name.localeCompare(t.city.name)}),e.forEach(function(e){selectList.innerHTML+='<li class="search__list-el" data-id="'.concat(e.id,'">').concat(e.city.name,"</li>")})},loadStacions=function(){dataWrapper.innerHTML='\n    <div class="loader">\n        <img class="loader__cloud-1" src="assets/images/Loader1.svg">\n        <img class="loader__cloud-2" src="assets/images/Loader2.svg">\n    </div>';var e=new FormData;e.append("url","http://api.gios.gov.pl/pjp-api/rest/station/findAll"),fetch("inc/ajax.php",{method:"POST",body:e}).then(function(e){return e.json()}).then(function(e){(stations=e).forEach(function(e){null!=e.addressStreet&&(e.city.name+=" "+e.addressStreet)}),createSelect(stations),loadSelectValue()}).catch(function(e){return console.log(e)})},showBtn=document.querySelectorAll(".popup-show-js"),closeBtn=document.querySelectorAll(".popup-close-js"),openPopup=function(e){document.getElementById(e).classList.add("active")},closePopup=function(e){document.getElementById(e).classList.remove("active"),returnHTML.innerHTML=""};closeBtn.forEach(function(e){e.addEventListener("click",function(){closePopup(e.dataset.id)})}),showBtn.forEach(function(e){e.addEventListener("click",function(){openPopup(e.dataset.id)})}),document.addEventListener("click",function(e){e.target.matches(".popup")&&closePopup(e.target.dataset.id)},!1),document.addEventListener("keydown",function(e){27==e.keyCode&&closeBtn.forEach(function(e){closePopup(e.dataset.id)})});var select=document.querySelector(".search__select"),selectList=document.querySelector(".search__list"),searchWrapper=document.querySelector(".search"),closeSearch=function(){selectList.classList.remove("active"),searchWrapper.classList.remove("active")},openSearch=function(){selectList.classList.add("active"),selectList.firstChild?searchWrapper.classList.add("active"):searchWrapper.classList.remove("active")};select.addEventListener("click",function(){openSearch()}),document.addEventListener("click",function(e){e.target.matches(".search__list-el")&&(select.dataset.id=e.target.dataset.id),e.target.matches(".search__select")||closeSearch()},!1);var handleArrowKey=function(e){for(var t=document.querySelectorAll(".search__list-el"),a=0;a<t.length;a++){if(t[a].classList.contains("active")){t[a].classList.remove("active");var s=void 0;40==e?(s=a+1)==t.length&&(s=0):38==e&&-1==(s=a-1)&&(s=t.length-1),t[s].classList.add("active"),t[s].scrollIntoView();break}a==t.length-1&&(40==e?(t[0].classList.add("active"),t[0].scrollIntoView()):38==e&&(t[t.length-1].classList.add("active"),t[t.length-1].scrollIntoView()))}};document.addEventListener("keydown",function(e){if(selectList.classList.contains("active")&&(40!=e.keyCode&&38!=e.keyCode||handleArrowKey(e.keyCode),13==e.keyCode)){var t=document.querySelector(".search__list-el.active");if(t)select.dataset.id=t.dataset.id,closeSearch();else{var a=document.querySelector(".search__list-el");a&&(select.dataset.id=a.dataset.id),closeSearch()}}}),document.addEventListener("mousemove",function(e){var t=document.querySelector(".search__list-el.active");t&&t.classList.remove("active"),e.target.matches(".search__list-el")&&e.target.classList.add("active")},!1);var sortSelect=function(e){var t=e.filter(function(e){return e.city.name.toLowerCase().includes(select.value.toLowerCase())});t.sort(function(e,t){return e.city.name.toLowerCase().startsWith(select.value.toLowerCase())?-1:e.city.name.toLowerCase().startsWith(select.value.toLowerCase())?1:void 0});var a="";t.forEach(function(e){a+='<li class="search__list-el" data-id="'.concat(e.id,'">').concat(e.city.name,"</li>")}),selectList.innerHTML=a};select.addEventListener("input",function(e){sortSelect(stations),openSearch()});var switchImage=function(){var e=document.querySelector(".image"),t=quality.stIndexLevel.indexLevelName,a="";"theme-dark"===localStorage.getItem("theme")&&(a="_Noc"),e.innerHTML="Bardzo dobry"==t||"Dobry"==t?'\n            <img class="image__bg" src="assets/images/Bardzo-dobry_Tlo'.concat(a,'.svg"> \n            <img class="image__cloud" src="assets/images/Bardzo-dobry_Chmurka').concat(a,'.svg"> \n            <img class="image__addition" src="assets/images/Bardzo-dobry_Dodatek').concat(a,'.svg"> \n            '):"Umiarkowany"==t||"Dostateczny"==t?'\n            <img class="image__bg" src="assets/images/Umiarkowany_Tlo'.concat(a,'.svg"> \n            <img class="image__cloud" src="assets/images/Umiarkowany_Chmurka').concat(a,'.svg"> \n            '):"Zły"==t||"Bardzo zły"==t?'\n            <img class="image__bg" src="assets/images/Zly_Tlo'.concat(a,'.svg"> \n            <img class="image__cloud" src="assets/images/Zly_Chmurka').concat(a,'.svg"> \n            '):'\n            <img class="image__bg" src="assets/images/Brak-danych_Tlo'.concat(a,'.svg"> \n            <img class="image__cloud" src="assets/images/Brak-danych-Chmurka').concat(a,'.svg"> \n            ')},themeBtn=document.querySelector(".theme-switch"),setTheme=function(e){localStorage.setItem("theme",e),document.documentElement.className=e},toggleTheme=function(){"theme-dark"===localStorage.getItem("theme")?(setTheme("theme-light"),themeBtn.classList.remove("active")):(setTheme("theme-dark"),themeBtn.classList.add("active")),switchImage()};"theme-dark"===localStorage.getItem("theme")?(setTheme("theme-dark"),themeBtn.classList.add("active")):(setTheme("theme-light"),themeBtn.classList.remove("active")),themeBtn.addEventListener("click",toggleTheme);var params=new URLSearchParams(window.location.search),unsubHTML=document.querySelector(".unsub-return-js"),token=params.get("t"),id=params.get("un");if(token&&id){openPopup("unsub"),unsubHTML.innerHTML='\n    <div class="loader loader--no-margin">\n        <img class="loader__cloud-1" src="assets/images/Loader1.svg">\n        <img class="loader__cloud-2" src="assets/images/Loader2.svg">\n    </div>';var data=new FormData;data.append("token",token),data.append("id",id),fetch("inc/unsub.php",{method:"POST",body:data}).then(function(e){return e.text()}).then(function(e){unsubHTML.innerHTML=e}).catch(function(e){unsubHTML.innerHTML=response})}select=document.querySelector(".search__select");var stations,sensors,quality,stationName=document.querySelector(".data__name"),htmlText="",dataWrapper=document.querySelector(".data"),counter=0,generateSearch=function(e){var t="?station=".concat(e);history.pushState(!1,"",t)},loadSelectValue=function(){var e=new URLSearchParams(window.location.search).get("station");e?select.dataset.id=e:null!=localStorage.getItem("station")?select.dataset.id=localStorage.getItem("station"):select.dataset.id=117,localStorage.setItem("station",select.dataset.id)},importStationToPopup=function(){var e=document.querySelector(".js-station"),t=stations.filter(function(e){return e.id==select.dataset.id});e.textContent=t[0].city.name};loadStacions();var observer=new MutationObserver(function(e){e.forEach(function(e){"attributes"==e.type&&(select.value=document.querySelector('.search__list-el[data-id="'.concat(select.dataset.id,'"]')).innerText,localStorage.setItem("station",select.dataset.id),htmlText="",counter=0,generateSearch(select.dataset.id),loadQuality(),importStationToPopup())})});observer.observe(select,{attributes:!0});